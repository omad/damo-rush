{% extends 'base.html' %}

{% block content %}
<div>
  <b-card header-tag="header" border-variant="primary" header-bg-variant="primary" header-text-variant="white">
    <h6 slot="header" class="mb-0">Generate a new deck</h6>
    <b-button href="#" v-on:click="gen_deck">Go !</b-button>
    <b-card-text>deck to process: {{deck.id}} {{deck.progress}}</b-card-text>
    <b-progress
      :value="deck.progress"
      :max="100"
      v-bind:variant="getBarColor(deck.step)"
      ></b-progress>
  </b-card>
</div>
{% endblock %}


{% block footer_js %}
<script>
  new Vue({
          el: '#app',
          data () {
            return {
              deck: {
                id:null,
                progress:0
              },
            }
          },
          methods: {
            gen_deck: function (event) {
              axios
                .get('/gen/api/new_deck')
                .then(response => {
                  this.deck = response.data

                  // we need to keep context, setinterval is executed without Vue context
                  var self = this;
                  this.refresh_progress = setInterval(function(){
                    axios
                      .get('/gen/api/status/'.concat(self.deck.id))
                      .then(response => (self.deck = response.data));
                    if (self.deck.step === 'done') {
                      clearInterval(self.refresh_progress);
                    }
                  }, 500);
                });
            },
            getBarColor(step){
              if (this.deck.step === "done"){
                return "success";
              }
              return "primary";
            }
          }
  })
</script>
{% endblock %}
